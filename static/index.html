<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SkillGuard â€” Skill Safety Classifier</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-primary: #0a0e17;
  --bg-secondary: #111827;
  --bg-card: #1a2236;
  --bg-input: #0f1629;
  --border: #2a3550;
  --text-primary: #e2e8f0;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --accent: #3b82f6;
  --accent-hover: #2563eb;
  --safe: #22c55e;
  --safe-bg: rgba(34,197,94,0.12);
  --caution: #eab308;
  --caution-bg: rgba(234,179,8,0.12);
  --dangerous: #f97316;
  --dangerous-bg: rgba(249,115,22,0.12);
  --malicious: #ef4444;
  --malicious-bg: rgba(239,68,68,0.12);
  --allow: #22c55e;
  --deny: #ef4444;
  --flag: #eab308;
  --radius: 8px;
  --radius-lg: 12px;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.6;
  min-height: 100vh;
}

.container { max-width: 900px; margin: 0 auto; padding: 24px 16px; }

/* Header */
header { text-align: center; margin-bottom: 32px; }
header h1 { font-size: 2rem; font-weight: 700; letter-spacing: -0.02em; }
header h1 span { color: var(--accent); }
header p { color: var(--text-secondary); margin-top: 4px; font-size: 0.95rem; }

/* API Key bar */
.api-key-bar {
  display: flex; gap: 8px; align-items: center;
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 10px 14px; margin-bottom: 24px;
}
.api-key-bar label { color: var(--text-secondary); font-size: 0.85rem; white-space: nowrap; }
.api-key-bar input {
  flex: 1; background: var(--bg-input); border: 1px solid var(--border);
  border-radius: 4px; padding: 6px 10px; color: var(--text-primary);
  font-family: monospace; font-size: 0.85rem; outline: none;
}
.api-key-bar input:focus { border-color: var(--accent); }

/* Cards */
.card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 20px; margin-bottom: 20px;
}
.card-title {
  font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.08em;
  color: var(--text-muted); margin-bottom: 12px; font-weight: 600;
}

/* Status section */
.status-row { display: flex; gap: 16px; flex-wrap: wrap; align-items: center; }
.status-badge {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;
}
.status-badge.online { background: var(--safe-bg); color: var(--safe); }
.status-badge.offline { background: var(--malicious-bg); color: var(--malicious); }
.status-badge .dot {
  width: 8px; height: 8px; border-radius: 50%; background: currentColor;
}
.status-meta { color: var(--text-secondary); font-size: 0.82rem; }
.status-meta span { margin-right: 16px; }
.status-meta code { color: var(--text-primary); font-size: 0.8rem; }

/* Tabs */
.tabs { display: flex; gap: 0; margin-bottom: 16px; border-bottom: 1px solid var(--border); }
.tab {
  padding: 8px 16px; cursor: pointer; font-size: 0.88rem;
  color: var(--text-secondary); border-bottom: 2px solid transparent;
  background: none; border-top: none; border-left: none; border-right: none;
  font-family: inherit; transition: color 0.15s;
}
.tab:hover { color: var(--text-primary); }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); }

/* Form elements */
textarea, input[type="text"] {
  width: 100%; background: var(--bg-input); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 10px 12px; color: var(--text-primary);
  font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  font-size: 0.85rem; resize: vertical; outline: none;
}
textarea:focus, input[type="text"]:focus { border-color: var(--accent); }
textarea { min-height: 160px; }

.form-row { display: flex; gap: 10px; margin-bottom: 12px; }
.form-row input { flex: 1; }

.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 10px 20px; border-radius: var(--radius);
  font-size: 0.9rem; font-weight: 600; cursor: pointer;
  border: none; transition: background 0.15s;
  font-family: inherit;
}
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent-hover); }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

.form-hint { color: var(--text-muted); font-size: 0.78rem; margin-top: 6px; }

/* Results */
.result-panel { display: none; }
.result-panel.visible { display: block; }

.result-header { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-bottom: 16px; }
.badge {
  display: inline-block; padding: 4px 14px; border-radius: 20px;
  font-size: 0.82rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em;
}
.badge-safe { background: var(--safe-bg); color: var(--safe); }
.badge-caution { background: var(--caution-bg); color: var(--caution); }
.badge-dangerous { background: var(--dangerous-bg); color: var(--dangerous); }
.badge-malicious { background: var(--malicious-bg); color: var(--malicious); }
.badge-allow { background: var(--safe-bg); color: var(--allow); }
.badge-deny { background: var(--malicious-bg); color: var(--deny); }
.badge-flag { background: var(--caution-bg); color: var(--flag); }

.confidence-row { margin-bottom: 14px; }
.confidence-label { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px; }
.bar-track {
  height: 8px; background: var(--bg-input); border-radius: 4px; overflow: hidden;
}
.bar-fill { height: 100%; border-radius: 4px; transition: width 0.4s ease; }

.score-bars { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
.score-item label {
  display: flex; justify-content: space-between;
  font-size: 0.78rem; color: var(--text-secondary); margin-bottom: 3px;
}
.score-item label span:last-child { color: var(--text-primary); }

.reasoning {
  background: var(--bg-input); border-radius: var(--radius);
  padding: 12px 14px; font-size: 0.85rem; color: var(--text-secondary);
  line-height: 1.5; white-space: pre-wrap;
}
.processing-time { color: var(--text-muted); font-size: 0.78rem; margin-top: 8px; }

/* Error display */
.error-box {
  background: var(--malicious-bg); border: 1px solid rgba(239,68,68,0.3);
  border-radius: var(--radius); padding: 12px 14px; color: var(--malicious);
  font-size: 0.85rem; display: none;
}
.error-box.visible { display: block; }

/* Stats grid */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; }
.stat-card {
  background: var(--bg-input); border-radius: var(--radius); padding: 14px;
  text-align: center;
}
.stat-value { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }
.stat-label { font-size: 0.72rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.06em; margin-top: 2px; }

/* Footer */
footer {
  text-align: center; color: var(--text-muted); font-size: 0.78rem;
  margin-top: 32px; padding-top: 16px; border-top: 1px solid var(--border);
}
footer a { color: var(--accent); text-decoration: none; }
footer a:hover { text-decoration: underline; }

/* Loading spinner */
.spinner {
  display: inline-block; width: 16px; height: 16px;
  border: 2px solid var(--border); border-top-color: var(--accent);
  border-radius: 50%; animation: spin 0.6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

@media (max-width: 600px) {
  .score-bars { grid-template-columns: 1fr; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .form-row { flex-direction: column; }
}
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <header>
    <h1><span>Skill</span>Guard</h1>
    <p>Standalone skill safety classifier for OpenClaw / ClawHub skills</p>
  </header>

  <!-- API Key -->
  <div class="api-key-bar">
    <label for="api-key">API Key</label>
    <input type="password" id="api-key" placeholder="Enter your API key (if required)" autocomplete="off">
  </div>

  <!-- Server Status -->
  <div class="card" id="status-card">
    <div class="card-title">Server Status</div>
    <div class="status-row">
      <span class="status-badge offline" id="status-badge"><span class="dot"></span> <span id="status-text">Checking...</span></span>
    </div>
    <div class="status-meta" id="status-meta" style="margin-top:10px"></div>
  </div>

  <!-- Evaluate -->
  <div class="card">
    <div class="card-title">Evaluate Skill</div>
    <div class="tabs">
      <button class="tab active" data-tab="paste">Paste SKILL.md</button>
      <button class="tab" data-tab="name">Lookup by Name</button>
    </div>

    <!-- Paste tab -->
    <div id="tab-paste">
      <textarea id="skill-input" placeholder="Paste a SKILL.md file or a full JSON evaluate request here..."></textarea>
      <div class="form-hint">Plain text is auto-wrapped into a skill structure. JSON objects with a &quot;skill&quot; key are sent directly.</div>
      <div style="margin-top:12px">
        <button class="btn btn-primary" id="btn-evaluate" onclick="evaluatePaste()">Evaluate</button>
      </div>
    </div>

    <!-- Name tab -->
    <div id="tab-name" style="display:none">
      <div class="form-row">
        <input type="text" id="skill-name" placeholder="Skill name (e.g. weather-helper)">
        <input type="text" id="skill-version" placeholder="Version (optional)">
      </div>
      <button class="btn btn-primary" id="btn-lookup" onclick="evaluateByName()">Lookup &amp; Evaluate</button>
    </div>
  </div>

  <!-- Error -->
  <div class="error-box" id="error-box"></div>

  <!-- Results -->
  <div class="card result-panel" id="result-panel">
    <div class="card-title">Results</div>
    <div class="result-header">
      <span class="badge" id="res-classification"></span>
      <span class="badge" id="res-decision"></span>
      <span style="color:var(--text-secondary);font-size:0.85rem" id="res-skill-name"></span>
    </div>

    <div class="confidence-row">
      <div class="confidence-label">Confidence: <strong id="res-confidence-val"></strong></div>
      <div class="bar-track"><div class="bar-fill" id="res-confidence-bar" style="width:0%;background:var(--accent)"></div></div>
    </div>

    <div class="score-bars" id="score-bars">
      <div class="score-item">
        <label><span>Safe</span><span id="score-safe">0%</span></label>
        <div class="bar-track"><div class="bar-fill" id="bar-safe" style="width:0%;background:var(--safe)"></div></div>
      </div>
      <div class="score-item">
        <label><span>Caution</span><span id="score-caution">0%</span></label>
        <div class="bar-track"><div class="bar-fill" id="bar-caution" style="width:0%;background:var(--caution)"></div></div>
      </div>
      <div class="score-item">
        <label><span>Dangerous</span><span id="score-dangerous">0%</span></label>
        <div class="bar-track"><div class="bar-fill" id="bar-dangerous" style="width:0%;background:var(--dangerous)"></div></div>
      </div>
      <div class="score-item">
        <label><span>Malicious</span><span id="score-malicious">0%</span></label>
        <div class="bar-track"><div class="bar-fill" id="bar-malicious" style="width:0%;background:var(--malicious)"></div></div>
      </div>
    </div>

    <div class="reasoning" id="res-reasoning"></div>
    <div class="processing-time" id="res-time"></div>
  </div>

  <!-- Stats -->
  <div class="card" id="stats-card">
    <div class="card-title">Usage Statistics</div>
    <div class="stats-grid" id="stats-grid">
      <div class="stat-card"><div class="stat-value" id="st-total">-</div><div class="stat-label">Total Requests</div></div>
      <div class="stat-card"><div class="stat-value" id="st-errors">-</div><div class="stat-label">Errors</div></div>
      <div class="stat-card"><div class="stat-value" id="st-safe">-</div><div class="stat-label">Safe</div></div>
      <div class="stat-card"><div class="stat-value" id="st-caution">-</div><div class="stat-label">Caution</div></div>
      <div class="stat-card"><div class="stat-value" id="st-dangerous">-</div><div class="stat-label">Dangerous</div></div>
      <div class="stat-card"><div class="stat-value" id="st-malicious">-</div><div class="stat-label">Malicious</div></div>
      <div class="stat-card"><div class="stat-value" id="st-allow">-</div><div class="stat-label">Allow</div></div>
      <div class="stat-card"><div class="stat-value" id="st-deny">-</div><div class="stat-label">Deny</div></div>
      <div class="stat-card"><div class="stat-value" id="st-flag">-</div><div class="stat-label">Flag</div></div>
      <div class="stat-card"><div class="stat-value" id="st-ep-eval">-</div><div class="stat-label">Evaluate</div></div>
      <div class="stat-card"><div class="stat-value" id="st-ep-name">-</div><div class="stat-label">By Name</div></div>
      <div class="stat-card"><div class="stat-value" id="st-ep-stats">-</div><div class="stat-label">Stats</div></div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <span id="footer-version">SkillGuard</span> &middot;
    <a href="https://github.com/hshadab/skillguard" target="_blank" rel="noopener">GitHub</a>
  </footer>

</div>

<script>
// ---- Helpers ----
function $(id) { return document.getElementById(id); }

function apiKey() { return $('api-key').value.trim(); }

function authHeaders() {
  const key = apiKey();
  const h = { 'Content-Type': 'application/json' };
  if (key) h['Authorization'] = 'Bearer ' + key;
  return h;
}

function showError(msg) {
  const el = $('error-box');
  el.textContent = msg;
  el.classList.add('visible');
}
function hideError() { $('error-box').classList.remove('visible'); }

// Persist API key in sessionStorage
$('api-key').addEventListener('input', function() {
  sessionStorage.setItem('sg_api_key', this.value);
});
(function() {
  const saved = sessionStorage.getItem('sg_api_key');
  if (saved) $('api-key').value = saved;
})();

// ---- Tabs ----
document.querySelectorAll('.tab').forEach(function(tab) {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
    tab.classList.add('active');
    var target = tab.getAttribute('data-tab');
    $('tab-paste').style.display = target === 'paste' ? '' : 'none';
    $('tab-name').style.display = target === 'name' ? '' : 'none';
  });
});

// ---- Health check ----
function checkHealth() {
  fetch('/health')
    .then(function(r) { return r.json(); })
    .then(function(d) {
      $('status-badge').className = 'status-badge online';
      $('status-text').textContent = 'Online';
      var uptime = formatUptime(d.uptime_seconds);
      var hash = d.model_hash.length > 20 ? d.model_hash.slice(0, 20) + '...' : d.model_hash;
      $('status-meta').innerHTML =
        '<span>Version: <code>' + escHtml(d.version) + '</code></span>' +
        '<span>Model: <code>' + escHtml(hash) + '</code></span>' +
        '<span>Uptime: <code>' + escHtml(uptime) + '</code></span>';
      $('footer-version').textContent = 'SkillGuard v' + d.version;
    })
    .catch(function() {
      $('status-badge').className = 'status-badge offline';
      $('status-text').textContent = 'Offline';
      $('status-meta').innerHTML = '';
    });
}

function formatUptime(s) {
  if (s < 60) return s + 's';
  if (s < 3600) return Math.floor(s / 60) + 'm ' + (s % 60) + 's';
  var h = Math.floor(s / 3600);
  var m = Math.floor((s % 3600) / 60);
  return h + 'h ' + m + 'm';
}

function escHtml(str) {
  var d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

checkHealth();
setInterval(checkHealth, 30000);

// ---- Stats ----
function loadStats() {
  fetch('/stats')
    .then(function(r) { return r.json(); })
    .then(function(d) {
      $('st-total').textContent = d.requests.total;
      $('st-errors').textContent = d.requests.errors;
      $('st-safe').textContent = d.classifications.safe;
      $('st-caution').textContent = d.classifications.caution;
      $('st-dangerous').textContent = d.classifications.dangerous;
      $('st-malicious').textContent = d.classifications.malicious;
      $('st-allow').textContent = d.decisions.allow;
      $('st-deny').textContent = d.decisions.deny;
      $('st-flag').textContent = d.decisions.flag;
      $('st-ep-eval').textContent = d.endpoints.evaluate;
      $('st-ep-name').textContent = d.endpoints.evaluate_by_name;
      $('st-ep-stats').textContent = d.endpoints.stats;
    })
    .catch(function() {});
}
loadStats();
setInterval(loadStats, 30000);

// ---- Evaluate (paste) ----
function evaluatePaste() {
  hideError();
  var raw = $('skill-input').value.trim();
  if (!raw) { showError('Please paste a SKILL.md or JSON payload.'); return; }

  var payload;
  try {
    var parsed = JSON.parse(raw);
    if (parsed.skill) {
      payload = parsed;
    } else if (parsed.name && parsed.skill_md) {
      payload = { skill: parsed };
    } else {
      payload = { skill: parsed };
    }
  } catch (e) {
    // Treat as plain SKILL.md text
    payload = {
      skill: {
        name: 'pasted-skill',
        version: '0.0.0',
        author: 'unknown',
        description: '',
        skill_md: raw,
        scripts: [],
        metadata: {},
        files: []
      }
    };
  }

  submitEvaluate('/api/v1/evaluate', payload);
}

// ---- Evaluate (by name) ----
function evaluateByName() {
  hideError();
  var name = $('skill-name').value.trim();
  if (!name) { showError('Please enter a skill name.'); return; }

  var payload = { skill: name };
  var ver = $('skill-version').value.trim();
  if (ver) payload.version = ver;

  submitEvaluate('/api/v1/evaluate/name', payload);
}

// ---- Submit ----
function submitEvaluate(url, body) {
  var btn = url.indexOf('/name') > -1 ? $('btn-lookup') : $('btn-evaluate');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Evaluating...';

  fetch(url, {
    method: 'POST',
    headers: authHeaders(),
    body: JSON.stringify(body)
  })
    .then(function(r) { return r.json().then(function(d) { return { status: r.status, data: d }; }); })
    .then(function(res) {
      btn.disabled = false;
      btn.textContent = url.indexOf('/name') > -1 ? 'Lookup & Evaluate' : 'Evaluate';
      if (res.status === 401) {
        showError(res.data.error || 'Unauthorized. Check your API key.');
        return;
      }
      if (!res.data.success) {
        showError(res.data.error || 'Evaluation failed.');
        return;
      }
      showResults(res.data);
      loadStats();
    })
    .catch(function(err) {
      btn.disabled = false;
      btn.textContent = url.indexOf('/name') > -1 ? 'Lookup & Evaluate' : 'Evaluate';
      showError('Request failed: ' + err.message);
    });
}

// ---- Display results ----
function showResults(data) {
  var ev = data.evaluation;
  var panel = $('result-panel');
  panel.classList.add('visible');

  // Classification badge
  var cls = ev.classification.toUpperCase();
  var clsBadge = $('res-classification');
  clsBadge.textContent = cls;
  clsBadge.className = 'badge badge-' + cls.toLowerCase();

  // Decision badge
  var dec = ev.decision.toUpperCase();
  var decBadge = $('res-decision');
  decBadge.textContent = dec;
  decBadge.className = 'badge badge-' + dec.toLowerCase();

  // Skill name
  $('res-skill-name').textContent = ev.skill_name;

  // Confidence
  var confPct = (ev.confidence * 100).toFixed(1);
  $('res-confidence-val').textContent = confPct + '%';
  $('res-confidence-bar').style.width = confPct + '%';

  // Score bars
  var scores = ev.scores;
  setScore('safe', scores.safe);
  setScore('caution', scores.caution);
  setScore('dangerous', scores.dangerous);
  setScore('malicious', scores.malicious);

  // Reasoning
  $('res-reasoning').textContent = ev.reasoning;

  // Processing time
  $('res-time').textContent = 'Processed in ' + data.processing_time_ms + 'ms';
}

function setScore(name, value) {
  var pct = (value * 100).toFixed(1);
  $('score-' + name).textContent = pct + '%';
  $('bar-' + name).style.width = pct + '%';
}
</script>
</body>
</html>
